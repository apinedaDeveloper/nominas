package enlace_datos.entidades.gestiones.horas_extras;

import enlace_datos.util.horario;
import enlace_datos.util.myEntityImpl;
import enlace_datos.util.utils;
import enlace_datos.util.utils_DB;

import oracle.jbo.AttributeList;
import oracle.jbo.JboException;
import oracle.jbo.Key;
import oracle.jbo.NameValuePairs;
import oracle.jbo.RowIterator;
import oracle.jbo.domain.Number;
import oracle.jbo.server.AttributeDefImpl;
import oracle.jbo.server.EntityDefImpl;
import oracle.jbo.server.EntityImpl;
import oracle.jbo.server.SequenceImpl;
import oracle.jbo.server.TransactionEvent;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class SisTiempoExtraordinarioImpl extends myEntityImpl {
    public static final int IDTIEMPOEXTRAORDINARIO = 0;
    public static final int PARTIDAGASTO = 1;
    public static final int TOTALHORASEXTRA = 2;
    public static final int VALORHORAEXTRA = 3;
    public static final int VALORNOMINAL = 4;
    public static final int VALORLIQUDO = 5;
    public static final int IDHORAEXTRA = 6;
    public static final int IDCONTRATO = 7;
    public static final int PARTIDASICOIN = 8;
    public static final int SISHORAEXTRA = 9;
    public static final int SISDESCUENTOTIEMPOEXTRA = 10;
    public static final int SISDETTIEMPOEXTRA = 11;
    private static EntityDefImpl mDefinitionObject;

    /**This is the default constructor (do not remove)
     */
    public SisTiempoExtraordinarioImpl() {
    }


    /**Retrieves the definition object for this instance class.
     */
    public static synchronized EntityDefImpl getDefinitionObject() {
        if (mDefinitionObject == null) {
            mDefinitionObject = (EntityDefImpl)EntityDefImpl.findDefObject("enlace_datos.entidades.gestiones.horas_extras.SisTiempoExtraordinario");
        }
        return mDefinitionObject;
    }

    /**Gets the attribute value for IdTiempoExtraordinario, using the alias name IdTiempoExtraordinario
     */
    public Number getIdTiempoExtraordinario() {
        return (Number)getAttributeInternal(IDTIEMPOEXTRAORDINARIO);
    }

    /**Sets <code>value</code> as the attribute value for IdTiempoExtraordinario
     */
    public void setIdTiempoExtraordinario(Number value) {
        setAttributeInternal(IDTIEMPOEXTRAORDINARIO, value);
    }

    /**Gets the attribute value for PartidaGasto, using the alias name PartidaGasto
     */
    public Number getPartidaGasto() {
        return (Number)getAttributeInternal(PARTIDAGASTO);
    }

    /**Sets <code>value</code> as the attribute value for PartidaGasto
     */
    public void setPartidaGasto(Number value) {
        setAttributeInternal(PARTIDAGASTO, value);
    }

    /**Gets the attribute value for TotalHorasExtra, using the alias name TotalHorasExtra
     */
    public Number getTotalHorasExtra() {
        return (Number)getAttributeInternal(TOTALHORASEXTRA);
    }

    /**Sets <code>value</code> as the attribute value for TotalHorasExtra
     */
    public void setTotalHorasExtra(Number value) {
        setAttributeInternal(TOTALHORASEXTRA, value);
    }

    /**Gets the attribute value for ValorHoraExtra, using the alias name ValorHoraExtra
     */
    public Number getValorHoraExtra() {
        return (Number)getAttributeInternal(VALORHORAEXTRA);
    }

    /**Sets <code>value</code> as the attribute value for ValorHoraExtra
     */
    public void setValorHoraExtra(Number value) {
        setAttributeInternal(VALORHORAEXTRA, value);
    }

    /**Gets the attribute value for ValorNominal, using the alias name ValorNominal
     */
    public Number getValorNominal() {
        return (Number)getAttributeInternal(VALORNOMINAL);
    }

    /**Sets <code>value</code> as the attribute value for ValorNominal
     */
    public void setValorNominal(Number value) {
        setAttributeInternal(VALORNOMINAL, value);
    }

    /**Gets the attribute value for ValorLiqudo, using the alias name ValorLiqudo
     */
    public Number getValorLiqudo() {
        return (Number)getAttributeInternal(VALORLIQUDO);
    }

    /**Sets <code>value</code> as the attribute value for ValorLiqudo
     */
    public void setValorLiqudo(Number value) {
        setAttributeInternal(VALORLIQUDO, value);
    }

    /**Gets the attribute value for IdHoraExtra, using the alias name IdHoraExtra
     */
    public Number getIdHoraExtra() {
        return (Number)getAttributeInternal(IDHORAEXTRA);
    }

    /**Sets <code>value</code> as the attribute value for IdHoraExtra
     */
    public void setIdHoraExtra(Number value) {
        setAttributeInternal(IDHORAEXTRA, value);
    }

    /**Gets the attribute value for IdContrato, using the alias name IdContrato
     */
    public Number getIdContrato() {
        return (Number)getAttributeInternal(IDCONTRATO);
    }

    /**Sets <code>value</code> as the attribute value for IdContrato
     */
    public void setIdContrato(Number value) {
        setAttributeInternal(IDCONTRATO, value);
    }

    /**getAttrInvokeAccessor: generated method. Do not modify.
     */
    protected Object getAttrInvokeAccessor(int index, 
                                           AttributeDefImpl attrDef) throws Exception {
        switch (index) {
        case IDTIEMPOEXTRAORDINARIO:
            return getIdTiempoExtraordinario();
        case PARTIDAGASTO:
            return getPartidaGasto();
        case TOTALHORASEXTRA:
            return getTotalHorasExtra();
        case VALORHORAEXTRA:
            return getValorHoraExtra();
        case VALORNOMINAL:
            return getValorNominal();
        case VALORLIQUDO:
            return getValorLiqudo();
        case IDHORAEXTRA:
            return getIdHoraExtra();
        case IDCONTRATO:
            return getIdContrato();
        case PARTIDASICOIN:
            return getPartidaSicoin();
        case SISDETTIEMPOEXTRA:
            return getSisDetTiempoExtra();
        case SISDESCUENTOTIEMPOEXTRA:
            return getSisDescuentoTiempoExtra();
        case SISHORAEXTRA:
            return getSisHoraExtra();
        default:
            return super.getAttrInvokeAccessor(index, attrDef);
        }
    }

    /**setAttrInvokeAccessor: generated method. Do not modify.
     */
    protected void setAttrInvokeAccessor(int index, Object value, 
                                         AttributeDefImpl attrDef) throws Exception {
        switch (index) {
        case IDTIEMPOEXTRAORDINARIO:
            setIdTiempoExtraordinario((Number)value);
            return;
        case PARTIDAGASTO:
            setPartidaGasto((Number)value);
            return;
        case TOTALHORASEXTRA:
            setTotalHorasExtra((Number)value);
            return;
        case VALORHORAEXTRA:
            setValorHoraExtra((Number)value);
            return;
        case VALORNOMINAL:
            setValorNominal((Number)value);
            return;
        case VALORLIQUDO:
            setValorLiqudo((Number)value);
            return;
        case IDHORAEXTRA:
            setIdHoraExtra((Number)value);
            return;
        case IDCONTRATO:
            setIdContrato((Number)value);
            return;
        case PARTIDASICOIN:
            setPartidaSicoin((Number)value);
            return;
        default:
            super.setAttrInvokeAccessor(index, value, attrDef);
            return;
        }
    }

    /**Gets the associated entity SisHoraExtraImpl
     */
    public SisHoraExtraImpl getSisHoraExtra() {
        return (SisHoraExtraImpl)getAttributeInternal(SISHORAEXTRA);
    }

    /**Sets <code>value</code> as the associated entity SisHoraExtraImpl
     */
    public void setSisHoraExtra(SisHoraExtraImpl value) {
        setAttributeInternal(SISHORAEXTRA, value);
    }

    /**Gets the associated entity oracle.jbo.RowIterator
     */
    public RowIterator getSisDescuentoTiempoExtra() {
        return (RowIterator)getAttributeInternal(SISDESCUENTOTIEMPOEXTRA);
    }

    /**Gets the associated entity oracle.jbo.RowIterator
     */
    public RowIterator getSisDetTiempoExtra() {
        return (RowIterator)getAttributeInternal(SISDETTIEMPOEXTRA);
    }

    /**Add locking logic here.
     */
    public void lock() {
        super.lock();
    }

    /**Custom DML update/insert/delete logic here.
     */
    protected void doDML(int operation, TransactionEvent e) {
        RowIterator fila;   
        Number sueldo;
        Double auxHora;
        horario hora1;
        horario hora2;
        String horaIni, horaFin;
        SisDetTiempoExtraImpl datActividad;
        Number horaExtra;
        Double sumHrExtra;
        Number numTiempoExtra;
        sumHrExtra = new Double(0);
       // System.out.println("CICLO HORA EXTRA empleado");
       
        Number hrContrato;
        //Number sueldo;
        //Number horaExtra;
        //int sumHrExtra;
        //Double auxHora;
        //horario hora1;
        //horario hora2;
        //String horaIni, horaFin;
        //SisDetTiempoExtraImpl datActividad;
         NameValuePairs restricPartidaGasto= new NameValuePairs();
        //obtengo la partida y el sueldo base del contrato seleccionado.
                    restricPartidaGasto.setAttribute("id_contrato",this.getIdContrato()); // 
                   // Object varPartida = utils_DB.getValorTabla(this.getDBTransaction(), "sis_contrato", "id_partida", restricPartidaGasto);
                   String consulta = "select cont.SUELDOBASE + nvl(cont.COMPL_SAL,0) + nvl(cont.ESCALAF,0) as nominal from sis_contrato cont\n" + 
                   "where id_contrato =  "+ this.getIdContrato() ;
                   // Object varSueldo= utils_DB.getValorTabla(this.getDBTransaction(), "sis_contrato", "sueldobase", restricPartidaGasto);
                  Object varSueldo; 
                  
                //  Object varSueldo = utils_DB.getEjecutarQuerry(this.getDBTransaction(),consulta);
                  /*  if (this.getSisHoraExtra().getIdPeriodo().getValue() < 7) 
                  //if (this.getSisHoraExtra().getIdPeriodo().compareTo(7) < 0 )
                  {*/
                      NameValuePairs parametro = new NameValuePairs();
                      parametro.setAttribute("1",this.getIdContrato().getValue());
                      parametro.setAttribute("2",this.getSisHoraExtra().getFechaini().getValue());
                      varSueldo =  utils_DB.getValorFuncion(this.getDBTransaction(),"sis_pkg_util.SUELDO_REAL(?,?)",parametro);
                      
                 /* }
                  else{
                       varSueldo = utils_DB.getEjecutarQuerry(this.getDBTransaction(),consulta);
                  }    */  
                   
                    Object varHrContrato= utils_DB.getValorTabla(this.getDBTransaction(), "sis_contrato", "horascontratadas", restricPartidaGasto);
                    hrContrato = utils.getNumberOracle(varHrContrato);
                    sueldo = utils.getNumberOracle(varSueldo);
         
        if (operation==this.DML_INSERT){  
               // Number numTiempoExtra;
                //RowIterator fila;
                
                SequenceImpl sequence = new SequenceImpl("SIS_TIEMPO_EXTRAORDI_SQ",e.getDBTransaction());
                numTiempoExtra = sequence.getSequenceNumber();
            //antes de guardar verificamos que los datos no esten nullos o vacios.
             if (this.getPartidaGasto() == null || this.getPartidaGasto().equals("")){
                 throw new JboException("PARTIDA GASTO:  Debe seleccionar la partida  ");    
             }else if (this.getIdContrato()== null || this.getIdContrato().equals("")){
                 throw new JboException("No. DE CONTRATO: El empleado asignado no tiene ningún contrato valido o no fue seleccionado. ");
             }
    
               //ESTA ERA LA FORMULAAAA PARA EL VALOR DE LA HORA EXTRA.
               // horaExtra = (Number)sueldo.divide(30).divide(hrContrato).multiply(1.5).round(2); cambie la formula por el nuevo manual
               //acuerdo de rectoria NO. 528-2011 modificado por acuerdo de rectoria No. 913-2011
               
                //System.out.println("el valor de la hora extra es "+ horaExtra);
                //sumHrExtra = 0;
                fila=this.getSisDetTiempoExtra();
                       //fila.reset();
                    //   regMovimientoPlaza = new SisMovimientoPlazaImpl();
                    
                        while(fila.hasNext() ){
                            auxHora = new Double (0);
                           //System.out.println("CICLO HORA EXTRA empleado");
                           datActividad =(SisDetTiempoExtraImpl)fila.next();
                           datActividad.setIdTiempoExtraordinario(numTiempoExtra);
                           
                          // horaIni = datActividad.getHoraInicio() ;
                           //horaFin = datActividad.getHoraFin();
                           hora1 = new horario (datActividad.gethrFictisia1());
                            //verificando si la hora fin de la actividad es a media noche
                            if (datActividad.gethrFictisia2().equals("0:00")){
                                hora2 = new horario ("24:01");
                            } else{
                                hora2 = new horario (datActividad.gethrFictisia2());
                            }
                           auxHora = hora2.getDiff_Horas(hora1);
                           sumHrExtra = auxHora + sumHrExtra;
                           
                           //System.out.println("sumahora extra "+ sumHrExtra);
                                                      
                           //System.out.println("que lleva hora");
                        } // fin del while
                        
                        
                /*  ESTA ERA LA FORMA ANTIGUA PARA EL CALCULO*************      
                //calculo el valor nominal de las horas extras del trabajador
                 sumHrExtra = Math.rint(sumHrExtra*100)/100;
                sueldo = (Number)horaExtra.multiply(sumHrExtra.doubleValue()).round(2);
                */
                
            //calculo el valor nominal de las horas extras del trabajador
            sumHrExtra = Math.rint(sumHrExtra*100)/100;
            sueldo = sueldo.multiply(sumHrExtra.doubleValue());
            horaExtra = hrContrato.multiply(20);
            sueldo = (Number)sueldo.divide(horaExtra).round(2);// total sueldo nominal
            horaExtra = (Number)sueldo.divide(sumHrExtra.doubleValue()).round(2);//valor Hora extra
                
                //obtengo el id de la partida gasto.
            restricPartidaGasto.clear();
                
             /*  Modificado por los nuevos requerimientos */   //esto ya estaba comentado no es parte de la ultima actualizacion
              //  restricPartidaGasto.setAttribute("1",varPartida);
               // restricPartidaGasto.setAttribute("2","HORA_EXTRA");
                //Object valPartidaGasto = utils_DB.getValorFuncion(this.getDBTransaction(),"sis_pkg_pagos.GetPartidaOtrosPagos(?,?)",restricPartidaGasto);
               // this.setPartidaGasto(utils.getNumberOracle(valPartidaGasto));
               
                this.setValorHoraExtra(horaExtra);
                this.setValorNominal(sueldo);
                this.setTotalHorasExtra(utils.getNumberOracle(sumHrExtra.doubleValue())) ;
                this.setIdTiempoExtraordinario(numTiempoExtra); 
                this.setValorLiqudo(new Number(0));
                
        }
        //se ingresaron mas actividades a un empleado
        else if(operation == this.DML_UPDATE){
            horaExtra = this.getValorHoraExtra();
            numTiempoExtra = this.getIdTiempoExtraordinario();
            fila=this.getSisDetTiempoExtra();
                   //fila.reset();
                //   regMovimientoPlaza = new SisMovimientoPlazaImpl();
                
                    while(fila.hasNext() ){
                        auxHora = new Double (0);
                       //System.out.println("CICLO HORA EXTRA empleado");
                       datActividad =(SisDetTiempoExtraImpl)fila.next();
                       //datActividad.setIdTiempoExtraordinario(numTiempoExtra);
                       
                      // horaIni = datActividad.getHoraInicio() ;
                       //horaFin = datActividad.getHoraFin();
                       hora1 = new horario (datActividad.gethrFictisia1());
                        //verificando si la hora fin de la actividad es a media noche
                        if (datActividad.gethrFictisia2().equals("0:00")){
                            hora2 = new horario ("24:01");
                        } else{
                            hora2 = new horario (datActividad.gethrFictisia2());
                        }
                       auxHora = hora2.getDiff_Horas(hora1);
                        
                       sumHrExtra = auxHora + sumHrExtra;
                       
                       //System.out.println("sumahora extra "+ sumHrExtra);
                                                  
                       //System.out.println("que lleva hora");
                    } // fin del while
                    
          /*     modificado, este era el calculo anterior     
            //calculo el valor nominal de las horas extras del trabajador
             sumHrExtra = Math.rint(sumHrExtra*100)/100;
            sueldo = (Number)horaExtra.multiply(sumHrExtra.doubleValue()).round(2);
            
            this.setValorNominal(sueldo);
            this.setTotalHorasExtra(utils.getNumberOracle(sumHrExtra.doubleValue()));
            
            */ // termina lo que fue la modificacion
             //calculo el valor nominal de las horas extras del trabajador
             sumHrExtra = Math.rint(sumHrExtra*100)/100;
             sueldo = sueldo.multiply(sumHrExtra.doubleValue());
             horaExtra = hrContrato.multiply(20);
             sueldo = (Number)sueldo.divide(horaExtra).round(2);// total sueldo nominal
             horaExtra = (Number)sueldo.divide(sumHrExtra.doubleValue()).round(2);//valor Hora extra
                 
                 //obtengo el id de la partida gasto.
             restricPartidaGasto.clear();
            
            this.setValorHoraExtra(horaExtra);
            this.setValorNominal(sueldo);
            this.setTotalHorasExtra(utils.getNumberOracle(sumHrExtra.doubleValue())) ;
            this.setIdTiempoExtraordinario(numTiempoExtra); 
            this.setValorLiqudo(new Number(0));
        }
       
        //capturando los mensajes desde la base de datos
        try { 
            
            registrarLogOperaciones(operation, e); 
            super.doDML(operation, e);           
        
        }
        
        catch (Exception exep) {
            //exep.printStackTrace();
            throw new JboException(utils.getSQLMensaje(exep));
             
                          //throw new myException(exep.getMessage());
             
        }
        
    }

    /**Add attribute defaulting logic in this method.
     */
    protected void create(AttributeList attributeList) {
        super.create(attributeList);
        this.setIdTiempoExtraordinario(new Number(System.currentTimeMillis()-9999999));
    }

    /**Gets the attribute value for PartidaSicoin, using the alias name PartidaSicoin
     */
    public Number getPartidaSicoin() {
        return (Number)getAttributeInternal(PARTIDASICOIN);
    }

    /**Sets <code>value</code> as the attribute value for PartidaSicoin
     */
    public void setPartidaSicoin(Number value) {
        setAttributeInternal(PARTIDASICOIN, value);
    }

    /**Creates a Key object based on given key constituents
     */
    public static Key createPrimaryKey(Number idTiempoExtraordinario) {
        return new Key(new Object[]{idTiempoExtraordinario});
    }
}
