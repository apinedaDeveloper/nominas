package enlace_datos.entidades.mensajes;

import enlace_datos.util.utils_DB;

import java.sql.ResultSet;

import oracle.jbo.Key;
import oracle.jbo.NameValuePairs;
import oracle.jbo.RowIterator;
import oracle.jbo.domain.Date;
import oracle.jbo.domain.Number;
import oracle.jbo.server.AttributeDefImpl;
import oracle.jbo.server.EntityDefImpl;
import oracle.jbo.server.EntityImpl;
import oracle.jbo.server.SequenceImpl;
import oracle.jbo.server.TransactionEvent;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class SisMensajeSalienteImpl extends EntityImpl {
    public static final int IDMENSAJESAL = 0;
    public static final int IDREPLY = 1;
    public static final int ASUNTO = 2;
    public static final int MENSAJE = 3;
    public static final int USUARIOENVIO = 4;
    public static final int PERFILDESTINO = 5;
    public static final int ESTADO = 6;
    public static final int FECHACREACION = 7;
    public static final int DESTINATARIOS = 8;
    public static final int NOENVIADOS = 9;
    public static final int IDREPLYSISMENSAJESALIENTE = 10;
    public static final int SISMENSAJESALIENTE = 11;
    public static final int SISMENSAJEENTRANTE = 12;
    public static final int SISDESTINATARIOMENSAJE = 13;
    private static EntityDefImpl mDefinitionObject;

    /**This is the default constructor (do not remove)
     */
    public SisMensajeSalienteImpl() {
    }


    /**Retrieves the definition object for this instance class.
     */
    public static synchronized EntityDefImpl getDefinitionObject() {
        if (mDefinitionObject == null) {
            mDefinitionObject = (EntityDefImpl)EntityDefImpl.findDefObject("enlace_datos.entidades.mensajes.SisMensajeSaliente");
        }
        return mDefinitionObject;
    }

    /**Gets the attribute value for IdMensajeSal, using the alias name IdMensajeSal
     */
    public Number getIdMensajeSal() {
        return (Number)getAttributeInternal(IDMENSAJESAL);
    }

    /**Sets <code>value</code> as the attribute value for IdMensajeSal
     */
    public void setIdMensajeSal(Number value) {
        setAttributeInternal(IDMENSAJESAL, value);
    }

    /**Gets the attribute value for IdReply, using the alias name IdReply
     */
    public Number getIdReply() {
        return (Number)getAttributeInternal(IDREPLY);
    }

    /**Sets <code>value</code> as the attribute value for IdReply
     */
    public void setIdReply(Number value) {
        setAttributeInternal(IDREPLY, value);
    }

    /**Gets the attribute value for Asunto, using the alias name Asunto
     */
    public String getAsunto() {
        return (String)getAttributeInternal(ASUNTO);
    }

    /**Sets <code>value</code> as the attribute value for Asunto
     */
    public void setAsunto(String value) {
        setAttributeInternal(ASUNTO, value);
    }

    /**Gets the attribute value for Mensaje, using the alias name Mensaje
     */
    public String getMensaje() {
        return (String)getAttributeInternal(MENSAJE);
    }

    /**Sets <code>value</code> as the attribute value for Mensaje
     */
    public void setMensaje(String value) {
        setAttributeInternal(MENSAJE, value);
    }

    /**Gets the attribute value for UsuarioEnvio, using the alias name UsuarioEnvio
     */
    public String getUsuarioEnvio() {
        return (String)getAttributeInternal(USUARIOENVIO);
    }

    /**Sets <code>value</code> as the attribute value for UsuarioEnvio
     */
    public void setUsuarioEnvio(String value) {
        setAttributeInternal(USUARIOENVIO, value);
    }

    /**Gets the attribute value for PerfilDestino, using the alias name PerfilDestino
     */
    public String getPerfilDestino() {
        return (String)getAttributeInternal(PERFILDESTINO);
    }

    /**Sets <code>value</code> as the attribute value for PerfilDestino
     */
    public void setPerfilDestino(String value) {
        setAttributeInternal(PERFILDESTINO, value);
    }

    /**Gets the attribute value for Estado, using the alias name Estado
     */
    public String getEstado() {
        return (String)getAttributeInternal(ESTADO);
    }

    /**Sets <code>value</code> as the attribute value for Estado
     */
    public void setEstado(String value) {
        setAttributeInternal(ESTADO, value);
    }

    /**Gets the attribute value for FechaCreacion, using the alias name FechaCreacion
     */
    public Date getFechaCreacion() {
        return (Date)getAttributeInternal(FECHACREACION);
    }

    /**Sets <code>value</code> as the attribute value for FechaCreacion
     */
    public void setFechaCreacion(Date value) {
        setAttributeInternal(FECHACREACION, value);
    }

    /**getAttrInvokeAccessor: generated method. Do not modify.
     */
    protected Object getAttrInvokeAccessor(int index, 
                                           AttributeDefImpl attrDef) throws Exception {
        switch (index) {
        case IDMENSAJESAL:
            return getIdMensajeSal();
        case IDREPLY:
            return getIdReply();
        case ASUNTO:
            return getAsunto();
        case MENSAJE:
            return getMensaje();
        case USUARIOENVIO:
            return getUsuarioEnvio();
        case PERFILDESTINO:
            return getPerfilDestino();
        case ESTADO:
            return getEstado();
        case FECHACREACION:
            return getFechaCreacion();
        case DESTINATARIOS:
            return getDestinatarios();
        case NOENVIADOS:
            return getNoEnviados();
        case SISMENSAJESALIENTE:
            return getSisMensajeSaliente();
        case SISMENSAJEENTRANTE:
            return getSisMensajeEntrante();
        case SISDESTINATARIOMENSAJE:
            return getSisDestinatarioMensaje();
        case IDREPLYSISMENSAJESALIENTE:
            return getIdReplySisMensajeSaliente();
        default:
            return super.getAttrInvokeAccessor(index, attrDef);
        }
    }

    /**setAttrInvokeAccessor: generated method. Do not modify.
     */
    protected void setAttrInvokeAccessor(int index, Object value, 
                                         AttributeDefImpl attrDef) throws Exception {
        switch (index) {
        case IDMENSAJESAL:
            setIdMensajeSal((Number)value);
            return;
        case IDREPLY:
            setIdReply((Number)value);
            return;
        case ASUNTO:
            setAsunto((String)value);
            return;
        case MENSAJE:
            setMensaje((String)value);
            return;
        case USUARIOENVIO:
            setUsuarioEnvio((String)value);
            return;
        case PERFILDESTINO:
            setPerfilDestino((String)value);
            return;
        case ESTADO:
            setEstado((String)value);
            return;
        case FECHACREACION:
            setFechaCreacion((Date)value);
            return;
        case DESTINATARIOS:
            setDestinatarios((String)value);
            return;
        case NOENVIADOS:
            setNoEnviados((String)value);
            return;
        default:
            super.setAttrInvokeAccessor(index, value, attrDef);
            return;
        }
    }

    /**Gets the associated entity SisMensajeSalienteImpl
     */
    public SisMensajeSalienteImpl getIdReplySisMensajeSaliente() {
        return (SisMensajeSalienteImpl)getAttributeInternal(IDREPLYSISMENSAJESALIENTE);
    }

    /**Sets <code>value</code> as the associated entity SisMensajeSalienteImpl
     */
    public void setIdReplySisMensajeSaliente(SisMensajeSalienteImpl value) {
        setAttributeInternal(IDREPLYSISMENSAJESALIENTE, value);
    }

    /**Gets the associated entity oracle.jbo.RowIterator
     */
    public RowIterator getSisMensajeSaliente() {
        return (RowIterator)getAttributeInternal(SISMENSAJESALIENTE);
    }

    /**Gets the associated entity oracle.jbo.RowIterator
     */
    public RowIterator getSisMensajeEntrante() {
        return (RowIterator)getAttributeInternal(SISMENSAJEENTRANTE);
    }

    /**Gets the attribute value for Destinatarios, using the alias name Destinatarios
     */
    public String getDestinatarios() {
        NameValuePairs parametros;
        Object valor;
        if (getAttributeInternal(DESTINATARIOS)==null && this.getIdMensajeSal()!=null){
            parametros= new NameValuePairs();
            parametros.setAttribute("uno",this.getIdMensajeSal());
            valor=utils_DB.getValorFuncion(this.getDBTransaction(),"sis_pkg_util.GETDESTINATARIOSMENSAJE(?)",parametros);
              if (valor!=null)
              this.setDestinatarios(valor.toString());
        }
       
        return (String)getAttributeInternal(DESTINATARIOS);
    }

    /**Sets <code>value</code> as the attribute value for Destinatarios
     */
    public void setDestinatarios(String value) {
        setAttributeInternal(DESTINATARIOS, value);
    }



    /**Add locking logic here.
     */
    public void lock() {
        super.lock();
    }

    /**Custom DML update/insert/delete logic here.
     */
    protected void doDML(int operation, TransactionEvent e) {
        RowIterator vFilas;
        SisDestinatarioMensajeImpl vDestinatario;
        String [] vDestinatarios;
        String [] vPerfiles=null;
        String vDest;
        String vNoEnviados="";
        String vQuerry;
        String vCadenaPerfiles;
        int vTamDestinatarios;
        int vIndice,vindiceNom;
        boolean vGrupo=false;
        ResultSet vListado;
        
        if (operation==DML_INSERT){
             SequenceImpl sequence = new SequenceImpl("sis_mensaje_saliente_sq",e.getDBTransaction());
             this.setIdMensajeSal(sequence.getSequenceNumber()); 
             
            if (this.getDestinatarios().startsWith("<perfil>")){
            
                vDestinatarios=this.getDestinatarios().split("\\|");
                vTamDestinatarios=vDestinatarios.length;
                vIndice=0;
            }else{
             vDestinatarios=this.getDestinatarios().split(",");
             vTamDestinatarios=vDestinatarios.length;
             vIndice=0;
            }
             
             
             vFilas=this.getSisDestinatarioMensaje();
             
                while (vIndice<vTamDestinatarios)
                {
                    vDest=vDestinatarios[vIndice].trim();
                     
                     vindiceNom=vDest.indexOf("]");
                     if (vindiceNom>0){
                         
                        vDest=vDest.substring(vindiceNom+1,vDest.length());   
                     }
                     
                     
                     if (vDest.startsWith("<perfil>")){
                         vGrupo=true; 
                         vDest=vDest.replace("<perfil>","");
                         vPerfiles=vDest.split(",");
                     }
                     else if (existeUsuario(vDest)){
                         vDestinatario=(SisDestinatarioMensajeImpl)vFilas.createRow(); 
                         vDestinatario.setIdMensajeSal(sequence.getSequenceNumber());
                         vDestinatario.setUsuario(vDest);    
                         vFilas.insertRow(vDestinatario);
                     }else{
                         vNoEnviados=vNoEnviados + ", "+ vDest;
                     }
                     
                     if (vGrupo==true) 
                     {
                        
                         vCadenaPerfiles="";
                         
                         for (int i=0;i<vPerfiles.length;i++) 
                         {
                             
                             vCadenaPerfiles=vCadenaPerfiles+"'"+vPerfiles[i].trim()+"',";
                             
                         }
                         
                         vCadenaPerfiles=( vCadenaPerfiles.equals("")?"' '":vCadenaPerfiles.substring(0,vCadenaPerfiles.length()-1));
                         
                         vQuerry="select distinct usuario \n" + 
                         "from usuario_perfil\n " + 
                         "where perfil in (" + vCadenaPerfiles+") "+ 
                         "and tipo_usuario='TRABAJADOR'\n " + 
                         "and activo=1 ";   
                         
                         try
                         {
                         
                             vListado=utils_DB.getEjecutarQuerry(this.getDBTransaction(),vQuerry,0);
                             
                             while (vListado!=null&&vListado.next())
                             {
                                 vDestinatario=(SisDestinatarioMensajeImpl)vFilas.createRow(); 
                                 vDestinatario.setIdMensajeSal(sequence.getSequenceNumber());
                                 vDestinatario.setUsuario(vListado.getString("usuario"));    
                                 vFilas.insertRow(vDestinatario);
                                 
                             }
                             
                         }catch(Exception exep){
                         
                              exep.printStackTrace(); 
                             
                         } 
                         
                     }
                     
                    vIndice++;    
                }
             
        }
        
        super.doDML(operation, e);
        
        if (vNoEnviados!=null&&vNoEnviados.length()>1){
            this.setNoEnviados(vNoEnviados.substring(2,vNoEnviados.length()));
                        }
    }

/*
 *  Verifica si existe el usuario
 */
    public boolean existeUsuario(String pUsuario){
        NameValuePairs valores=new NameValuePairs();
        Object vResultConsulta;
        valores.setAttribute("usuario",pUsuario);
        valores.setAttribute("tipo_usuario","TRABAJADOR");
        //valores.setAttribute("perfil like 'SIS%'",null);
        vResultConsulta=utils_DB.getValorTabla(this.getDBTransaction(),"usuario_perfil","count(0)",valores);
            if (vResultConsulta!=null&&vResultConsulta.toString().equals("0")){
                return false;
            }
        
        return true;
    }

    public String getGrupoUsuario(){
        NameValuePairs valores=new NameValuePairs();
        Object vResultConsulta;
        valores.setAttribute("usuario",this.getUsuarioEnvio());
        vResultConsulta=utils_DB.getValorTabla(this.getDBTransaction(),"usuario","",valores); 
        return "";
    }

    
    public void actualizaEstado(String pEstado){
        this.getDBTransaction().executeCommand("update sis_mensaje_saliente set estado=" +pEstado +" where id_mensaje_sal="+this.getIdMensajeSal() );
        
    }
    
    /**Gets the associated entity oracle.jbo.RowIterator
     */
    public RowIterator getSisDestinatarioMensaje() {
        return (RowIterator)getAttributeInternal(SISDESTINATARIOMENSAJE);
    }

    /**Gets the attribute value for NoEnviados, using the alias name NoEnviados
     */
    public String getNoEnviados() {
        return (String)getAttributeInternal(NOENVIADOS);
    }

    /**Sets <code>value</code> as the attribute value for NoEnviados
     */
    public void setNoEnviados(String value) {
        setAttributeInternal(NOENVIADOS, value);
    }

    /**Creates a Key object based on given key constituents
     */
    public static Key createPrimaryKey(Number idMensajeSal) {
        return new Key(new Object[]{idMensajeSal});
    }
}
