package enlace_datos.consultas.varios;

import enlace_datos.consultas.varios.common.Sis_historial_salarial;

import enlace_datos.util.utils;

import java.sql.ResultSet;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import oracle.jbo.Row;
import oracle.jbo.domain.Date;
import oracle.jbo.domain.Number;
import oracle.jbo.server.ViewObjectImpl;
import oracle.jbo.server.ViewRowImpl;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class Sis_historial_salarialImpl extends ViewObjectImpl implements Sis_historial_salarial {
    /**This is the default constructor (do not remove)
     */
     
    private boolean ejecutar_consulta=true;
    Number TotalBono;
    
    
    public Sis_historial_salarialImpl() {
    
    }

    /**executeQueryForCollection - overridden for custom java data source support.
     */
    protected void executeQueryForCollection(Object qc, Object params[], int noUserParams) {
        
        if (ejecutar_consulta==false){
            this.setWhereClause("id_nomina<0");            
        }
        
        
        super.executeQueryForCollection(qc, params, noUserParams);
    }

    /**hasNextForCollection - overridden for custom java data source support.
     */
    protected boolean hasNextForCollection(Object qc) {
        boolean bRet = super.hasNextForCollection(qc);
        return bRet;
    }

    /**createRowFromResultSet - overridden for custom java data source support.
     */
    protected ViewRowImpl createRowFromResultSet(Object qc, 
                                                 ResultSet resultSet) {
        ViewRowImpl value = super.createRowFromResultSet(qc, resultSet);
        return value;
    }

    /**getEstimatedRowCount - overridden for custom java data source support.
     */
    public long getEstimatedRowCount() {
        long value = super.getEstimatedRowCount();
        return value;
    }
    
    
    public String addCondicion(String pQuerry,String pCondicion){
       String vNuevoQuerry="";  
        if (pQuerry.length()>0){
            vNuevoQuerry=pQuerry + " and " + pCondicion;
        }else {
            vNuevoQuerry=pCondicion; 
        }
      return vNuevoQuerry;  
    }
    
    
    public String getLista(Iterator vLista){
        String vTempo="";
        
        while (vLista.hasNext()){
          vTempo+=vLista.next().toString()+","; 
        }
            
          vTempo="(" + vTempo.substring(0,vTempo.length()-1) + ")";                
     return vTempo;   
    }
    
    
    public String getIntervaloFechas(Date pFechaI,Date pFechaF,String pOpcion){
        int vInter1,vInter2;
        int vAnioI,vAnioF;
        int vPeriodo;
        int vDiffMeses;
        int vRecorrido;
        long vDiffMili;
        String vIntervalo,vMascara;
        
       
        vDiffMeses=0;
        if (pOpcion.equals("MES")){
            
            vMascara="MM";
            
            vAnioI=Integer.parseInt(utils.getFechaFormato("yyyy",pFechaI));
            vAnioF=Integer.parseInt(utils.getFechaFormato("yyyy",pFechaF));
            
            vDiffMeses=0;
            
            if (vAnioF>vAnioI){
                
                vDiffMili=pFechaF.timestampValue().getTime()-pFechaI.timestampValue().getTime();
                vDiffMeses=new Double((vDiffMili/(1000*3600*24))/30).intValue();
                
                //vDiffMeses=12;
                
                if (vDiffMeses>12){
                    vDiffMeses=12;   
                }
                
                
            }else{
                
                vDiffMeses=Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaF));
                vDiffMeses=vDiffMeses-Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaI));
                
            }
            
            
        }else {
            
            vMascara="yyyy";
            vDiffMeses=Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaF));
            vDiffMeses=vDiffMeses-Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaI));
            
        }
        
        
        
        vInter1=Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaI));
        
        
        
        if (pFechaF!=null){
        
    //    vInter2=Integer.parseInt(utils.getFechaFormato(vMascara,(Date)pFechaF));       
        
        vIntervalo="";  
        vPeriodo=vInter1;
        
            for (int a=0;a<=vDiffMeses;a++){
            
              if (vPeriodo>12 && pOpcion.equals("MES"))
                  vPeriodo=1;
                  
                vIntervalo+=String.valueOf(vPeriodo)+","; 
                
                vPeriodo++;
            }
            
            vIntervalo="(" + vIntervalo.substring(0,vIntervalo.length()-1) + ")"; 
            
       
        }else{ // El intervalo es la fecha de inicio
            vIntervalo="("+String.valueOf(vInter1)+")";
        }
  return vIntervalo;
    }
        
    
    public void generar_consulta(List pParametros, String pUsuario){
        String pConsulta="",vTempo="";
        ArrayList vValores;
        Object vTemp1;
        if (pParametros!=null){    
            // Registro de empleado
            if (pParametros.get(0)!=null){
                pConsulta="registro_empleado="+pParametros.get(0);
            }
            //dependencias
            if (pParametros.get(1)!=null){
                vValores=(ArrayList)pParametros.get(1);          
                vTempo=getLista(vValores.iterator());
                vTempo="id_dependencia in " + vTempo;  
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            // Unidades
            if (pParametros.get(2)!=null){
                vValores=(ArrayList)pParametros.get(2);
                String vTempo2="";
                String [] vTempo3;
                vTempo="";
                Iterator vFilas;
                vFilas=vValores.iterator();
                while (vFilas.hasNext()){
                    vTempo2=vFilas.next().toString(); 
                    vTempo3=vTempo2.split("\\.");
                    vTempo+="(id_programa="+vTempo3[0] +" and id_dependencia=" +vTempo3[1]  + " and id_unidad="+vTempo3[2]+ ") or";
                }
                vTempo="(" + vTempo.substring(0,vTempo.length()-3) + ")";
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            //plan de egresos
            if (pParametros.get(3)!=null){
                vValores=(ArrayList)pParametros.get(3);          
                vTempo=getLista(vValores.iterator());
                vTempo=" d1d2 in " + vTempo;                
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            //renglones
            if (pParametros.get(4)!=null){
                vValores=(ArrayList)pParametros.get(4);          
                vTempo=getLista(vValores.iterator());
                vTempo="d9d10 in " + vTempo;                
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            //Tipo Nomina
            if (pParametros.get(5)!=null){
                vValores=(ArrayList)pParametros.get(5);          
                vTempo=getLista(vValores.iterator());
                if (vValores.contains("1") ){
                    vTempo="id_tipo_nomina in " + vTempo + " and d9d10 not in (0,75,76,72,81)";                    
                }else{
                    vTempo="id_tipo_nomina in " + vTempo;                    
                }
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            // tipo proceso                          
            if (pParametros.get(13)!=null){
                vValores=(ArrayList)pParametros.get(13);          
                vTempo=getLista(vValores.iterator());
                vTempo="tipoproceso in " + vTempo+" and id_proceso<>101";                
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            //Descuentos 
            if (pParametros.get(6)!=null){
                vValores=(ArrayList)pParametros.get(6);          
                vTempo=getLista(vValores.iterator());
                vTempo="exists(select 1 from sis_Det_calculo_ajuste x where x.id_nomina=QRSLT.id_nomina and id_ajuste in " + vTempo + ")";                
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            // num pago
            if (pParametros.get(12)!=null){
                vTemp1=pParametros.get(12); 
                vTempo=" num_doc_fisico = "+vTemp1 + "";
                pConsulta=addCondicion(pConsulta,vTempo);
            } else {
                //Fechas, periodo de busqueda.       
                if (pParametros.get(7)!=null){
                    vTempo=getIntervaloFechas((Date)pParametros.get(7),(pParametros.get(8)!=null?(Date)pParametros.get(8):utils.getFechaActual()),"MES");    
                    vTempo=" id_periodo in "+vTempo;
                    pConsulta=addCondicion(pConsulta,vTempo);
                    vTempo=getIntervaloFechas((Date)pParametros.get(7),(pParametros.get(8)!=null?(Date)pParametros.get(8):utils.getFechaActual()),"ANIO");    
                    vTempo=" anio in "+vTempo;
                    pConsulta=addCondicion(pConsulta,vTempo);
                }else{
                    pConsulta=addCondicion(pConsulta,"anio="+utils.getAnioActual());
                }
            }  
            if (pParametros.get(9)!=null){
                vValores=(ArrayList)pParametros.get(9);          
                vTempo=getLista(vValores.iterator());
                vTempo=" id_puesto in "+vTempo;
                pConsulta=addCondicion(pConsulta,vTempo);
            }
            if (pParametros.get(10)!=null){
                vTemp1=pParametros.get(10); 
                if (!vTemp1.equals("TODOS")){
                    vTempo=" NomTipo = '"+vTemp1+"'";    
                    pConsulta=addCondicion(pConsulta,vTempo);
                }
            }
            // Nombre del empleado
            if (pParametros.get(11)!=null){
                vTemp1=pParametros.get(11); 
                vTempo=" nombrecompleto like '%" +vTemp1.toString().toUpperCase()+"%'";
                pConsulta=addCondicion(pConsulta,vTempo);        
            }
            // CUI
            if (pParametros.get(14)!=null && !pParametros.get(14).toString().trim().equals("")){
                pConsulta=addCondicion(pConsulta,"cui='"+pParametros.get(14))+"'";
            }
        } if (pConsulta.length()>0){
            ejecutar_consulta=true;
            this.setcond(new Number(1));
            this.setpUsuario(pUsuario);
            this.setWhereClause(pConsulta);
            this.setOrderByClause("codigoNomina ASC");
            this.executeQuery();  
        }else{
            ejecutar_consulta=false;  
            this.setcond(new Number(0));
            this.setpUsuario(pUsuario);
            this.executeQuery();
        }
    }


    /**Gets the bind variable value for cond
     */
    public Number getcond() {
        return (Number)getNamedWhereClauseParam("cond");
    }

    /**Sets <code>value</code> for bind variable cond
     */
    public void setcond(Number value) {
        setNamedWhereClauseParam("cond", value);
    }
    
    public void consultaEmpl(Number pRegistroEmpleado,Number pAnio){
        String pConsulta;
        
        if (pRegistroEmpleado !=null && pAnio!=null)
        {
        pConsulta="registro_empleado="+pRegistroEmpleado + " and anio="+pAnio + " and id_estado in (18,17,160)";    
        this.setcond(new Number(1));
        this.setpUsuario(pRegistroEmpleado+"");
        ejecutar_consulta=true;
        this.setWhereClause(pConsulta);
        this.executeQuery();
            
        }

        
    }
    
    
    public void consultaEmplNoAnulados(Number pRegistroEmpleado,Number pAnio){
        String pConsulta;
        if (pRegistroEmpleado !=null && pAnio!=null)    {
            pConsulta="registro_empleado="+pRegistroEmpleado + " and anio="+pAnio + " and id_estado in (18,160)";    
            this.setcond(new Number(2));
            this.setpUsuario(pRegistroEmpleado+"");
            ejecutar_consulta=true;
            this.setWhereClause(pConsulta);
            this.setOrderByClause("ID_PROCESO DESC");
            this.executeQuery(); 
        }
    }

    
   public Number getTotalNominal()
{
   
       Row [] vFilas;
       Number vTotalNominal;
       vFilas=this.getAllRowsInRange();
       vTotalNominal=new Number(0);   
       TotalBono=new Number(0);   
      try
      {
          
      
       if (vFilas!=null && vFilas.length>0)
       {
           for (int i=0; i<vFilas.length;i++)
           {
             if (vFilas[i].getAttribute("FechaAnulacion")==null)
             {
              vTotalNominal=vTotalNominal.add((Number)vFilas[i].getAttribute("Nominal"));
              TotalBono=TotalBono.add((Number)vFilas[i].getAttribute("TotalBono"));
             }
           }                               
           
       }
      }catch(Exception exep)
      {
          vTotalNominal=new Number(0);
      }
       
  return vTotalNominal;     
}
    
  public Number getTotalBono(){
      return TotalBono;
  }

    //Procedimiento para obtener los ultimos sueldos para el calculo de Indemnización por Retiro
     public void obtenerUltimosSueldosTrabajador(Number pRegistroEmpleado) {
         String pClausula;
         if ( pRegistroEmpleado != null ) {
             pClausula = "registro_empleado=" + pRegistroEmpleado;
             pClausula += " and id_estado in (18,160) and id_tipo_nomina = 1 and tipoproceso = 1";
             this.setcond(new Number(1)); //para activar una condición adicional
             this.setWhereClause(pClausula);
             this.setOrderByClause("correlativo desc, codigonomina desc");
             this.executeQuery();
         }
     }

    /**Gets the bind variable value for pUsuario
     */
    public String getpUsuario() {
        return (String)getNamedWhereClauseParam("pUsuario");
    }

    /**Sets <code>value</code> for bind variable pUsuario
     */
    public void setpUsuario(String value) {
        setNamedWhereClauseParam("pUsuario", value);
    }
}
