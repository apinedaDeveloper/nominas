package enlace_datos.consultas.gestiones;

import enlace_datos.consultas.complementos.SisComplementoDetVwRowImpl;

import enlace_datos.consultas.gestiones.common.SisDetalleReintegroVw;

import enlace_datos.util.utils;
import enlace_datos.util.utils_DB;

import java.sql.ResultSet;

import java.sql.SQLException;

import oracle.jbo.JboException;
import oracle.jbo.NameValuePairs;
import oracle.jbo.Row;
import oracle.jbo.RowIterator;
import oracle.jbo.ViewObject;
import oracle.jbo.domain.Number;
import oracle.jbo.server.ViewObjectImpl;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class SisDetalleReintegroVwImpl extends ViewObjectImpl implements SisDetalleReintegroVw {
    /**This is the default constructor (do not remove)
     */
    public SisDetalleReintegroVwImpl() {
    }

    /**Gets the bind variable value for pReintegro
     */
    public Number getpReintegro() {
        return (Number)getNamedWhereClauseParam("pReintegro");
    }

    /**Sets <code>value</code> for bind variable pReintegro
     */
    public void setpReintegro(Number value) {
        setNamedWhereClauseParam("pReintegro", value);
    }
    
    public void agregarDescuento(Number pIdReintegroDet,Number pIdAjuste,Number pValor,String pUsuario){
        Object resultado = "CORRECTO";
        NameValuePairs vParametros;
        vParametros = new NameValuePairs();
        
        vParametros.setAttribute("1",pIdReintegroDet);
        vParametros.setAttribute("2",pIdAjuste);
        vParametros.setAttribute("3",pValor);
        
               
        if(pIdAjuste.equals("21") || pIdAjuste.equals("25")){
            resultado=utils_DB.getValorFuncion(this.getDBTransaction(),"sis_pkg_pagos.validaDescIGSSReintegro(?,?,?)",vParametros);
        }
        
        // validar que tenga nominal mayor a cero      
        SisDetalleReintegroVwRowImpl vfila;        
        vfila=(SisDetalleReintegroVwRowImpl)this.getCurrentRow();
        double vNominal = Double.parseDouble(vfila.getNominal().toString());
        double vEscalafon = Double.parseDouble(vfila.getEscalafon().toString());
        double vComplSal = Double.parseDouble(vfila.getComplSalarial().toString());
        
        if(!(vNominal >0) && !(pIdAjuste.compareTo(27)==0)){
            throw new JboException("Para agregar un descuento el nominal debe ser mayor que cero","01",null);
        }
        // fin validacion
        
        if(resultado.equals("CORRECTO")){
            vParametros.setAttribute("4",pUsuario);
            if (!utils_DB.ejecutarProcedimiento(this.getDBTransaction(),"sis_pkg_pagos.AgregarDescuentoReintegro(?,?,?,?)",vParametros)){
               throw new JboException("Ha ocurrido un error, por favor intente nuevamente","01",null);
                
            }else{
                this.getDBTransaction().commit();
            }
         }
         else{
             throw new JboException(resultado.toString());              
         }
                                
    }
    
    public void borrarDetReintegro(){
        
        SisDetalleReintegroVwRowImpl vfila;        
        vfila=(SisDetalleReintegroVwRowImpl)this.getCurrentRow();        
        utils_DB.getEjecutarConsulta(this.getDBTransaction(),"delete from sis_descuento_reintegro where id_detalle_reintegro="+vfila.getIdDetalleReintegro());                
        this.removeCurrentRow();             
    }
    
    public void actualiza_desc_bono(){    
        if (this.getRowCount()>0)     
        ((SisDetalleReintegroVwRowImpl)this.getCurrentRow()).actualiza_desc_bono();            
    }
    
    public void actualizaTotalPagoReintegro(Number pIdReintegro){
        
        ResultSet abc =utils_DB.getEjecutarQuerry(this.getDBTransaction(),"select sum(liquido) total from sis_detalle_reintegro where id_reintegro= "+pIdReintegro.toString(),1);
        String valor = "0";
        try {
            if(abc.next()){
                valor = abc.getString("total");
            }
        } catch (SQLException e) {
            // TODO
        }
        String updateTotalPagar =
        "update sis_reintegro set total_pagar="+valor+" where id_reintegro ="+pIdReintegro.toString();
        utils_DB.getEjecutarConsulta(this.getDBTransaction(),updateTotalPagar);
        this.getDBTransaction().commit();
    }
    
    public void generarAutomaticoDesc(Number pIdDetReintegro){
        NameValuePairs vParametros;
        vParametros = new NameValuePairs();
        
        vParametros.setAttribute("1",pIdDetReintegro);
        vParametros.setAttribute("2",utils.getAuthUser(this.getDBTransaction()));
        if (!utils_DB.ejecutarProcedimiento(this.getDBTransaction(),"sis_pkg_pagos.generarAutomaticoDescReintegro(?,?)",vParametros)){
           throw new JboException("Ha ocurrido un error, por favor intente nuevamente","01",null);
            
        }else{
            this.getDBTransaction().commit();
        }
    }
    
    public void cambiarEstadoTodos(Boolean pValor){
        
       Row []pFilas;
       int vTam; 
       pFilas=this.getAllRowsInRange();
        
       vTam=pFilas.length;
       
       for (int i=0;i<vTam;i++){
         
         pFilas[i].setAttribute("isSel",pValor);  
           
       }
                
    }
    
    public void cambiarEstadoActual(Boolean pValor){
        
        
       Row pFila;
       pFila=this.getCurrentRow();
       pFila.setAttribute("isSel",pValor);  
       
                
    }
    
    public void posicionaSeleccionado(){
        Row []pFilas;
        int vTam; 
        pFilas=this.getAllRowsInRange();
         
        vTam=pFilas.length;
        
        for (int i=0;i<vTam;i++){
          
          if ((Boolean)pFilas[i].getAttribute("isSel")==true){
              this.setCurrentRow(pFilas[i]);
              break;
          }
            
        }     
            
            
    } 
}
